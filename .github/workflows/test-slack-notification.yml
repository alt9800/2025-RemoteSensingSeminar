name: Test Slack Notification
on:
  workflow_dispatch:
    inputs:
      target_date:
        description: 'テスト対象の日付 (YYYY-MM-DD) - 空欄で最新'
        required: false
        type: string
      notification_type:
        description: 'テストする通知タイプ'
        required: true
        type: choice
        options:
          - 'bot_with_pdf'
          - 'webhook_with_links'
          - 'no_slide_notification'
          - 'test_all_methods'
        default: 'test_all_methods'
      test_message:
        description: 'テスト識別用メッセージ'
        required: false
        type: string
        default: '🧪 Slack通知テスト'

jobs:
  test-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -fv

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Determine target date
        id: target
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.target_date }}"
          else
            TARGET_DATE=$(find . -maxdepth 1 -type d -name '[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]' | sort -r | head -n1 | sed 's|./||')
          fi
          
          echo "target_date=$TARGET_DATE" >> $GITHUB_OUTPUT
          echo "🎯 Target date: $TARGET_DATE"
          
          if [ -f "$TARGET_DATE/slide.md" ]; then
            echo "slide_exists=true" >> $GITHUB_OUTPUT
            echo "✅ Found slide.md in $TARGET_DATE"
          else
            echo "slide_exists=false" >> $GITHUB_OUTPUT
            echo "❌ slide.md not found in $TARGET_DATE"
          fi

      - name: Check Slack configuration
        id: config
        run: |
          echo "🔍 Checking Slack configuration..."
          
          if [ -n "${{ secrets.SLACK_BOT_TOKEN }}" ] && [ -n "${{ secrets.SLACK_REVIEW_CHANNEL }}" ]; then
            echo "bot_available=true" >> $GITHUB_OUTPUT
            echo "✅ Bot Token configuration found"
          else
            echo "bot_available=false" >> $GITHUB_OUTPUT
            echo "❌ Bot Token configuration missing"
          fi
          
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "webhook_available=true" >> $GITHUB_OUTPUT
            echo "✅ Webhook configuration found"
          else
            echo "webhook_available=false" >> $GITHUB_OUTPUT
            echo "❌ Webhook configuration missing"
          fi

      - name: Generate test PDF
        if: steps.target.outputs.slide_exists == 'true' && (github.event.inputs.notification_type == 'bot_with_pdf' || github.event.inputs.notification_type == 'test_all_methods')
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          
          echo "📄 Generating test PDF for $TARGET_DATE..."
          
          mkdir -p test-output
          
          cd "$TARGET_DATE"
          marp "slide.md" \
            --pdf \
            --allow-local-files \
            --output "../test-output/test-$TARGET_DATE.pdf"
          cd ..
          
          PDF_SIZE=$(stat -c%s "test-output/test-$TARGET_DATE.pdf")
          echo "📊 PDF size: $PDF_SIZE bytes"
          
          if [ $PDF_SIZE -gt 10485760 ]; then
            echo "⚠️ PDF size exceeds Slack limit (10MB)"
            echo "テスト用に小さなPDFを生成します..."
            
            cd "$TARGET_DATE"
            head -50 slide.md > slide_short.md
            marp "slide_short.md" \
              --pdf \
              --allow-local-files \
              --output "../test-output/test-$TARGET_DATE.pdf"
            rm slide_short.md
            cd ..
            
            NEW_SIZE=$(stat -c%s "test-output/test-$TARGET_DATE.pdf")
            echo "📊 Shortened PDF size: $NEW_SIZE bytes"
            
            if [ $NEW_SIZE -le 10485760 ]; then
              echo "✅ Test PDF size OK for Slack"
              echo "pdf_too_large=false" >> $GITHUB_ENV
            fi
          else
            echo "✅ PDF size OK for Slack"
            echo "pdf_too_large=false" >> $GITHUB_ENV
          fi

      - name: Debug information
        if: (github.event.inputs.notification_type == 'bot_with_pdf' || github.event.inputs.notification_type == 'test_all_methods') && steps.config.outputs.bot_available == 'true' && steps.target.outputs.slide_exists == 'true'
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_REVIEW_CHANNEL }}
        run: |
          echo "🔍 Debug information:"
          echo "  - Bot available: ${{ steps.config.outputs.bot_available }}"
          echo "  - Slide exists: ${{ steps.target.outputs.slide_exists }}"
          echo "  - PDF too large: ${{ env.pdf_too_large }}"
          echo "  - Channel ID: $SLACK_CHANNEL"
          echo "  - File exists: $([ -f "test-output/test-${{ steps.target.outputs.target_date }}.pdf" ] && echo "YES" || echo "NO")"
          
          if [ -f "test-output/test-${{ steps.target.outputs.target_date }}.pdf" ]; then
            FILE_SIZE=$(stat -c%s "test-output/test-${{ steps.target.outputs.target_date }}.pdf")
            echo "  - File size: $FILE_SIZE bytes"
          fi

      - name: Test Bot Token notification
        if: (github.event.inputs.notification_type == 'bot_with_pdf' || github.event.inputs.notification_type == 'test_all_methods') && steps.config.outputs.bot_available == 'true' && steps.target.outputs.slide_exists == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_REVIEW_CHANNEL }}
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y年%m月%d日 %H:%M JST')
          TEST_MSG="${{ github.event.inputs.test_message }}"
          
          echo "🤖 Testing Bot Token notification..."
          echo "   Target date: $TARGET_DATE"
          echo "   Channel: $SLACK_CHANNEL"
          
          if [ ! -f "test-output/test-$TARGET_DATE.pdf" ]; then
            echo "❌ PDF file not found: test-output/test-$TARGET_DATE.pdf"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s "test-output/test-$TARGET_DATE.pdf")
          echo "📊 File size: $FILE_SIZE bytes"
          
          # Method 1: PDFファイル実体送信を試行
          echo "📤 Attempting PDF file upload..."
          
          # Step 1: アップロードURLを取得
          echo "Step 1: Getting upload URL..."
          UPLOAD_URL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            --data-raw "{\"filename\":\"test-slide-$TARGET_DATE.pdf\",\"length\":$FILE_SIZE}" \
            https://slack.com/api/files.getUploadURLExternal)
          
          echo "Upload URL response: $UPLOAD_URL_RESPONSE"
          
          if echo "$UPLOAD_URL_RESPONSE" | grep -q '"ok":true'; then
            # アップロードURLとファイルIDを抽出
            UPLOAD_URL=$(echo "$UPLOAD_URL_RESPONSE" | grep -o '"upload_url":"[^"]*"' | cut -d'"' -f4)
            FILE_ID=$(echo "$UPLOAD_URL_RESPONSE" | grep -o '"file_id":"[^"]*"' | cut -d'"' -f4)
            
            echo "✅ Upload URL obtained"
            echo "   Upload URL: $UPLOAD_URL"
            echo "   File ID: $FILE_ID"
            
            # Step 2: ファイルをアップロード
            echo "Step 2: Uploading file..."
            UPLOAD_RESPONSE=$(curl -s -X POST \
              -F file=@"test-output/test-$TARGET_DATE.pdf" \
              "$UPLOAD_URL")
            
            echo "File upload response: $UPLOAD_RESPONSE"
            UPLOAD_STATUS=$?
            
            if [ $UPLOAD_STATUS -eq 0 ]; then
              echo "✅ File uploaded to external URL"
              
              # Step 3: アップロード完了を通知
              echo "Step 3: Completing upload..."
              COMPLETE_RESPONSE=$(curl -s -X POST \
                -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                -H "Content-Type: application/json" \
                --data-raw "{\"files\":[{\"id\":\"$FILE_ID\",\"title\":\"テスト用スライド ($TARGET_DATE)\"}]}" \
                https://slack.com/api/files.completeUploadExternal)
              
              echo "Complete upload response: $COMPLETE_RESPONSE"
              
              if echo "$COMPLETE_RESPONSE" | grep -q '"ok":true'; then
                echo "✅ Upload completed successfully"
                
                # Step 4: チャンネルに共有
                echo "Step 4: Sharing to channel..."
                
                MESSAGE_TEXT="$TEST_MSG - $CURRENT_TIME

                📋 レビューポイント:
                • 内容の正確性
                • 説明の分かりやすさ
                • 時間配分
                • スライドデザイン
                
                💬 フィードバック方法: このスレッドにコメントをお願いします
                
                ⚠️ これはテスト通知です"
                
                SHARE_RESPONSE=$(curl -s -X POST \
                  -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                  -H "Content-Type: application/json" \
                  --data-raw "{\"channel\":\"$SLACK_CHANNEL\",\"text\":\"$MESSAGE_TEXT\",\"files\":[\"$FILE_ID\"]}" \
                  https://slack.com/api/chat.postMessage)
                
                echo "Share response: $SHARE_RESPONSE"
                
                if echo "$SHARE_RESPONSE" | grep -q '"ok":true'; then
                  echo "🎉 PDF file upload successful! File attached to Slack message."
                else
                  echo "❌ Failed to share file to channel"
                  echo "Trying alternative sharing method..."
                  
                  # 代替方法: files.shareを試す
                  ALT_SHARE_RESPONSE=$(curl -s -X POST \
                    -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                    -H "Content-Type: application/json" \
                    --data-raw "{\"file\":\"$FILE_ID\",\"channels\":\"$SLACK_CHANNEL\",\"initial_comment\":\"$MESSAGE_TEXT\"}" \
                    https://slack.com/api/files.share)
                  
                  echo "Alternative share response: $ALT_SHARE_RESPONSE"
                  
                  if echo "$ALT_SHARE_RESPONSE" | grep -q '"ok":true'; then
                    echo "🎉 PDF file shared successfully using files.share!"
                  else
                    echo "❌ Both sharing methods failed"
                  fi
                fi
              else
                echo "❌ Failed to complete upload"
                ERROR_MSG=$(echo "$COMPLETE_RESPONSE" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)
                echo "   Error: $ERROR_MSG"
              fi
            else
              echo "❌ File upload to external URL failed"
            fi
          else
            echo "❌ Failed to get upload URL"
            ERROR_MSG=$(echo "$UPLOAD_URL_RESPONSE" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)
            echo "   Error: $ERROR_MSG"
          fi
          
          # Method 2: フォールバック - リンク送信
          echo ""
          echo "🔄 Fallback: Sending message with GitHub Pages link..."
          
          GITHUB_LINK="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/slides/$TARGET_DATE.pdf"
          FALLBACK_MESSAGE="$TEST_MSG - $CURRENT_TIME
                          
          📋 レビューポイント:
          • 内容の正確性
          • 説明の分かりやすさ
          • 時間配分
          • スライドデザイン
          
          💬 フィードバック方法: このスレッドにコメントをお願いします
          
          📎 PDFリンク: $GITHUB_LINK
          
          ⚠️ これはテスト通知です（フォールバック）"
          
          FALLBACK_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            --data-raw "{\"channel\":\"$SLACK_CHANNEL\",\"text\":\"$FALLBACK_MESSAGE\"}" \
            https://slack.com/api/chat.postMessage)
          
          echo "Fallback response: $FALLBACK_RESPONSE"
          
          if echo "$FALLBACK_RESPONSE" | grep -q '"ok":true'; then
            echo "✅ Fallback message sent successfully"
          else
            echo "❌ Fallback also failed"
            ERROR_MSG=$(echo "$FALLBACK_RESPONSE" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)
            echo "   Error: $ERROR_MSG"
          fi

      - name: Test Webhook notification
        if: (github.event.inputs.notification_type == 'webhook_with_links' || github.event.inputs.notification_type == 'test_all_methods') && steps.config.outputs.webhook_available == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y年%m月%d日 %H:%M JST')
          TEST_MSG="${{ github.event.inputs.test_message }}"
          
          echo "🪝 Testing Webhook notification..."
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$TEST_MSG - Webhook テスト\\n\\n${CURRENT_TIME} 時点での資料はこちらです。レビューをお願いします。\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"📋 レビューポイント:\\n• 内容の正確性\\n• 説明の分かりやすさ\\n• 時間配分\\n• スライドデザイン\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": { \"type\": \"plain_text\", \"text\": \"📄 PDFダウンロード\" },
                      \"url\": \"${PAGES_URL}/slides/${TARGET_DATE}.pdf\",
                      \"style\": \"primary\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": { \"type\": \"plain_text\", \"text\": \"📊 HTMLプレビュー\" },
                      \"url\": \"${PAGES_URL}/slides/${TARGET_DATE}.html\"
                    }
                  ]
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"⚠️ これはテスト通知です | 💬 このスレッドにフィードバックをお願いします\"
                    }
                  ]
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL
          
          if [ $? -eq 0 ]; then
            echo "✅ Webhook test successful!"
          else
            echo "❌ Webhook test failed"
          fi

      - name: Test no-slide notification
        if: github.event.inputs.notification_type == 'no_slide_notification' || github.event.inputs.notification_type == 'test_all_methods'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          PAGES_URL="https://alt9800.github.io/2025-RemoteSensingSeminar"
          TEST_MSG="${{ github.event.inputs.test_message }}"
          
          echo "📭 Testing no-slide notification..."
          
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"$TEST_MSG - スライドなし通知テスト\\n\\n⚠️ **レビュー通知**\\n\\nまだ出来上がってないみたいです、少々お待ちください...\"
                    }
                  },
                  {
                    \"type\": \"actions\",
                    \"elements\": [
                      {
                        \"type\": \"button\",
                        \"text\": { \"type\": \"plain_text\", \"text\": \"📋 資料サイトで確認\" },
                        \"url\": \"${PAGES_URL}\",
                        \"style\": \"primary\"
                      }
                    ]
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"⚠️ これはテスト通知です | 📝 資料の準備ができ次第、改めてレビュー依頼をお送りします\"
                      }
                    ]
                  }
                ]
              }" \
              $SLACK_WEBHOOK_URL
            
            if [ $? -eq 0 ]; then
              echo "✅ No-slide notification test successful!"
            else
              echo "❌ No-slide notification test failed"
            fi
          else
            echo "⚠️ Webhook URL not configured, skipping no-slide test"
          fi

      - name: Test summary
        if: always()
        run: |
          echo "## 🧪 Slack通知テスト結果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**テスト実行日時:** $(TZ=Asia/Tokyo date '+%Y年%m月%d日 %H:%M JST')" >> $GITHUB_STEP_SUMMARY
          echo "**対象日付:** ${{ steps.target.outputs.target_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**テストタイプ:** ${{ github.event.inputs.notification_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 📊 設定状況" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.config.outputs.bot_available }}" = "true" ]; then
            echo "- ✅ Bot Token設定済み" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Bot Token未設定" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.config.outputs.webhook_available }}" = "true" ]; then
            echo "- ✅ Webhook設定済み" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Webhook未設定" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.target.outputs.slide_exists }}" = "true" ]; then
            echo "- ✅ スライドファイル存在" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ スライドファイルなし" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 💡 次のステップ" >> $GITHUB_STEP_SUMMARY
          echo "1. Slackでテスト通知を確認してください" >> $GITHUB_STEP_SUMMARY
          echo "2. 問題があれば設定を見直してください" >> $GITHUB_STEP_SUMMARY
          echo "3. 正常であれば本番用ワークフローを有効にしてください" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -rf test-output