name: Weekly Slide Review
on:
  schedule:
    - cron: '0 3 * * 3' # æ¯é€±æ°´æ›œæ—¥ 12:00 JST
  workflow_dispatch:
    inputs:
      target_date:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®æ—¥ä»˜ (YYYY-MM-DD) - ç©ºæ¬„ã§æœ€æ–°'
        required: false
        type: string
      force_send:
        description: 'ã‚¹ãƒ©ã‚¤ãƒ‰ãŒãªãã¦ã‚‚é€šçŸ¥ã‚’é€ã‚‹'
        required: false
        type: boolean
        default: false

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Check if seminar period is active
        id: period_check
        run: |
          CURRENT_DATE=$(date '+%Y%m%d')
          END_DATE="20250801"
          
          if [ $CURRENT_DATE -gt $END_DATE ]; then
            echo "ğŸ›‘ ã‚»ãƒŸãƒŠãƒ¼æœŸé–“çµ‚äº†: $CURRENT_DATE > $END_DATE"
            echo "period_active=false" >> $GITHUB_OUTPUT
            
            # çµ‚äº†é€šçŸ¥ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æº–å‚™
            echo "end_message=ğŸ“š ã‚»ãƒŸãƒŠãƒ¼æœŸé–“ãŒçµ‚äº†ã—ãŸãŸã‚ã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯åœæ­¢ã•ã‚Œã¾ã—ãŸã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼" >> $GITHUB_OUTPUT
          else
            echo "âœ… ã‚»ãƒŸãƒŠãƒ¼æœŸé–“ä¸­: $CURRENT_DATE <= $END_DATE"
            echo "period_active=true" >> $GITHUB_OUTPUT
          fi

      - name: Send final notification (if period ended)
        if: steps.period_check.outputs.period_active == 'false'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"${{ steps.period_check.outputs.end_message }}\"
                    }
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"ä»Šå¾Œã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•ã§ç„¡åŠ¹åŒ–ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚\"
                      }
                    ]
                  }
                ]
              }" \
              $SLACK_WEBHOOK_URL
          fi
          
          echo "::warning::ã‚»ãƒŸãƒŠãƒ¼æœŸé–“çµ‚äº†ã®ãŸã‚ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¦ãã ã•ã„"
          exit 0

      - name: Checkout repository
        if: steps.period_check.outputs.period_active == 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.period_check.outputs.period_active == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Japanese fonts
        if: steps.period_check.outputs.period_active == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -fv

      - name: Install Marp CLI
        if: steps.period_check.outputs.period_active == 'true'
        run: npm install -g @marp-team/marp-cli

      - name: Determine target date
        if: steps.period_check.outputs.period_active == 'true'
        id: target
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.target_date }}"
          else
            # æœ€æ–°ã®æ—¥ä»˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
            TARGET_DATE=$(find . -maxdepth 1 -type d -name '[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]' | sort -r | head -n1 | sed 's|./||')
          fi
          
          echo "target_date=$TARGET_DATE" >> $GITHUB_OUTPUT
          echo "Target date: $TARGET_DATE"
          
          # ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$TARGET_DATE/slide.md" ]; then
            echo "slide_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Found slide.md in $TARGET_DATE"
          else
            echo "slide_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ slide.md not found in $TARGET_DATE"
          fi

      - name: Generate review PDF
        if: steps.target.outputs.slide_exists == 'true' && steps.period_check.outputs.period_active == 'true'
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          
          echo "Generating review PDF for $TARGET_DATE..."
          
          # PDFãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p review-output
          
          # PDFç”Ÿæˆï¼ˆå…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã—ã¦ç›¸å¯¾ãƒ‘ã‚¹ç¶­æŒï¼‰
          cd "$TARGET_DATE"
          marp "slide.md" \
            --pdf \
            --allow-local-files \
            --output "../review-output/review-$TARGET_DATE.pdf"
          cd ..
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          PDF_SIZE=$(stat -c%s "review-output/review-$TARGET_DATE.pdf")
          echo "PDF size: $PDF_SIZE bytes"
          
          # Slackç”¨ã®åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ10MB = 10485760 bytesï¼‰
          if [ $PDF_SIZE -gt 10485760 ]; then
            echo "âš ï¸ PDF size exceeds Slack limit (10MB)"
            echo "pdf_too_large=true" >> $GITHUB_ENV
          else
            echo "âœ… PDF size OK for Slack"
            echo "pdf_too_large=false" >> $GITHUB_ENV
          fi

      - name: Determine notification method
        if: steps.period_check.outputs.period_active == 'true'
        id: notification
        run: |
          if [ -n "${{ secrets.SLACK_BOT_TOKEN }}" ] && [ -n "${{ secrets.SLACK_REVIEW_CHANNEL }}" ]; then
            echo "method=bot" >> $GITHUB_OUTPUT
            echo "ğŸ“¤ Using Bot Token for file upload"
          elif [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "method=webhook" >> $GITHUB_OUTPUT
            echo "ğŸ“¤ Using Webhook for link sharing"
          else
            echo "method=none" >> $GITHUB_OUTPUT
            echo "âŒ No Slack configuration found"
          fi

      - name: Send Slack notification with PDF (Bot Token)
        if: steps.target.outputs.slide_exists == 'true' && steps.notification.outputs.method == 'bot' && env.pdf_too_large == 'false' && steps.period_check.outputs.period_active == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_REVIEW_CHANNEL }}
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          CURRENT_TIME=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M JST')
          
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’å¤‰æ•°ã«æ ¼ç´
          MESSAGE="$CURRENT_TIME æ™‚ç‚¹ã§ã®è³‡æ–™ã¯ã“ã¡ã‚‰ã§ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
          
          ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ:
          â€¢ å†…å®¹ã®æ­£ç¢ºæ€§
          â€¢ èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•  
          â€¢ æ™‚é–“é…åˆ†
          â€¢ ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³
          
          ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ–¹æ³•: ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™
          
          ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼"
          
          # PDFã‚’Slackã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          UPLOAD_RESPONSE=$(curl -F file=@"review-output/review-$TARGET_DATE.pdf" \
            -F channels="$SLACK_CHANNEL" \
            -F title="ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚¹ãƒ©ã‚¤ãƒ‰ ($TARGET_DATE)" \
            -F initial_comment="$MESSAGE" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            https://slack.com/api/files.upload)
          
          echo "Slack upload response: $UPLOAD_RESPONSE"
          
          # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸç¢ºèª
          if echo "$UPLOAD_RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… PDF successfully uploaded to Slack"
          else
            echo "âŒ Failed to upload PDF to Slack"
            echo "$UPLOAD_RESPONSE"
            exit 1
          fi

      - name: Send Slack notification with link (Webhook or large PDF)
        if: steps.target.outputs.slide_exists == 'true' && (steps.notification.outputs.method == 'webhook' || env.pdf_too_large == 'true') && steps.period_check.outputs.period_active == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          CURRENT_TIME=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M JST')
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"${CURRENT_TIME} æ™‚ç‚¹ã§ã®è³‡æ–™ã¯ã“ã¡ã‚‰ã§ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚\\n\\nâš ï¸ PDFã‚µã‚¤ã‚ºãŒå¤§ãã„ãŸã‚ã€ãƒªãƒ³ã‚¯ã§ã®å…±æœ‰ã¨ãªã‚Šã¾ã™\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ:\\nâ€¢ å†…å®¹ã®æ­£ç¢ºæ€§\\nâ€¢ èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•\\nâ€¢ æ™‚é–“é…åˆ†\\nâ€¢ ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": { \"type\": \"plain_text\", \"text\": \"ğŸ“„ PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\" },
                      \"url\": \"${PAGES_URL}/slides/${TARGET_DATE}.pdf\",
                      \"style\": \"primary\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": { \"type\": \"plain_text\", \"text\": \"ğŸ“Š HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\" },
                      \"url\": \"${PAGES_URL}/slides/${TARGET_DATE}.html\"
                    }
                  ]
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"ğŸ’¬ ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™\"
                    }
                  ]
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL

      - name: Send no-slide notification
        if: steps.target.outputs.slide_exists == 'false' && github.event.inputs.force_send == 'true' && steps.period_check.outputs.period_active == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TARGET_DATE="${{ steps.target.outputs.target_date }}"
          PAGES_URL="https://alt9800.github.io/2025-RemoteSensingSeminar"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"âš ï¸ **ãƒ¬ãƒ“ãƒ¥ãƒ¼é€šçŸ¥**\\n\\nã¾ã å‡ºæ¥ä¸ŠãŒã£ã¦ãªã„ã¿ãŸã„ã§ã™ã€å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": { \"type\": \"plain_text\", \"text\": \"ğŸ“‹ è³‡æ–™ã‚µã‚¤ãƒˆã§ç¢ºèª\" },
                      \"url\": \"${PAGES_URL}\",
                      \"style\": \"primary\"
                    }
                  ]
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"ğŸ“ è³‡æ–™ã®æº–å‚™ãŒã§ãæ¬¡ç¬¬ã€æ”¹ã‚ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã‚’ãŠé€ã‚Šã—ã¾ã™\"
                    }
                  ]
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL

      - name: Send no-configuration warning
        if: steps.notification.outputs.method == 'none' && steps.period_check.outputs.period_active == 'true'
        run: |
          echo "âš ï¸ Slack configuration missing!"
          echo ""
          echo "To enable Slack notifications, add one of:"
          echo "1. Bot Token (recommended for file uploads):"
          echo "   - SLACK_BOT_TOKEN"
          echo "   - SLACK_REVIEW_CHANNEL"
          echo ""
          echo "2. Webhook (links only):"
          echo "   - SLACK_WEBHOOK_URL"
          echo ""
          echo "PDF generated at: review-output/review-${{ steps.target.outputs.target_date }}.pdf"

      - name: Cleanup
        if: always()
        run: |
          rm -rf review-output