name: Deploy Seminar Materials
on:
  push:
    branches: [ main ]
    paths:
      - '*/slide.md'
      - '*/handson/**'
      - '*/assets/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          # ãƒ•ã‚©ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
          fc-cache -fv

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Find all seminar directories
        id: find-dirs
        run: |
          # å…¨ã¦ã®æ—¥ä»˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
          ALL_DATES=$(find . -maxdepth 1 -type d -name '[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]' | sed 's|./||' | sort)
          
          echo "Found directories:"
          echo "$ALL_DATES"
          
          if [ -n "$ALL_DATES" ]; then
            echo "has_directories=true" >> $GITHUB_OUTPUT
            echo "all_dates<<EOF" >> $GITHUB_OUTPUT
            echo "$ALL_DATES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_directories=false" >> $GITHUB_OUTPUT
          fi

      - name: Create docs directories
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mkdir -p docs/slides
          mkdir -p docs/handson

      - name: Generate materials
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "${{ steps.changes.outputs.changed_dates }}" | while read DATE_DIR; do
            if [ -n "$DATE_DIR" ] && [ -d "$DATE_DIR" ]; then
              echo "Processing $DATE_DIR..."
              
              # assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’docs/slides/ã«ã‚³ãƒ”ãƒ¼ï¼ˆç”»åƒç”¨ï¼‰
              if [ -d "$DATE_DIR/assets" ]; then
                echo "Copying assets for $DATE_DIR"
                mkdir -p "docs/slides/assets"
                cp -r "$DATE_DIR/assets"/* "docs/slides/assets/"
                # ã‚‚ã—ãã¯æ—¥ä»˜åˆ¥ã®assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
                mkdir -p "docs/slides/$DATE_DIR-assets"
                cp -r "$DATE_DIR/assets"/* "docs/slides/$DATE_DIR-assets/"
              fi
              
              # åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚³ãƒ”ãƒ¼
              find "$DATE_DIR" -maxdepth 1 \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" \) | while read img_file; do
                if [ -f "$img_file" ]; then
                  echo "Copying image: $img_file"
                  cp "$img_file" "docs/slides/"
                  # æ—¥ä»˜åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚‚ã‚³ãƒ”ãƒ¼
                  mkdir -p "docs/slides/$DATE_DIR-assets"
                  cp "$img_file" "docs/slides/$DATE_DIR-assets/"
                fi
              done
              
              # ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ (slide.mdãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿)
              if [ -f "$DATE_DIR/slide.md" ]; then
                echo "Generating slides for $DATE_DIR"
                
                # ä¸€æ™‚çš„ã«slide.mdã®ç”»åƒãƒ‘ã‚¹ã‚’èª¿æ•´ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆ
                cp "$DATE_DIR/slide.md" "temp-slide.md"
                
                # ç›¸å¯¾ãƒ‘ã‚¹ã‚’èª¿æ•´ï¼ˆHTMLç”¨ï¼‰
                sed 's|!\[\([^]]*\)\](\([^)]*\))|![\1](./'$DATE_DIR'-assets/\2)|g' "temp-slide.md" > "temp-slide-html.md"
                # assetsãƒ•ã‚©ãƒ«ãƒ€å†…ã®ç”»åƒãƒ‘ã‚¹ã‚‚èª¿æ•´
                sed -i 's|assets/|'$DATE_DIR'-assets/|g' "temp-slide-html.md"
                
                # HTMLç”Ÿæˆï¼ˆèª¿æ•´ã•ã‚ŒãŸãƒ‘ã‚¹ä½¿ç”¨ï¼‰
                marp "temp-slide-html.md" \
                  --html \
                  --allow-local-files \
                  --output "docs/slides/$DATE_DIR.html"
                
                # PDFç”Ÿæˆï¼ˆå…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ slide.md ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šï¼‰
                cd "$DATE_DIR"
                marp slide.md \
                  --pdf \
                  --allow-local-files \
                  --output "../docs/slides/$DATE_DIR.pdf"
                cd ..
                
                # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
                rm -f "temp-slide.md" "temp-slide-html.md"
                
                echo "âœ… Generated slides for $DATE_DIR"
              else
                echo "âš ï¸ slide.md not found in $DATE_DIR"
              fi
              
              # ãƒãƒ³ã‚ºã‚ªãƒ³è³‡æ–™ã®ã‚³ãƒ”ãƒ¼ (handsonãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿)
              if [ -d "$DATE_DIR/handson" ]; then
                echo "Copying handson materials for $DATE_DIR"
                
                # handsonãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼
                cp -r "$DATE_DIR/handson" "docs/handson/$DATE_DIR"
                
                echo "âœ… Copied handson materials for $DATE_DIR"
              else
                echo "â„¹ï¸ handson directory not found in $DATE_DIR"
              fi
            fi
          done

      - name: Generate site index
        if: steps.find-dirs.outputs.has_directories == 'true'
        run: |
          cat > docs/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ğŸ“š ã‚»ãƒŸãƒŠãƒ¼è³‡æ–™</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
              <style>
                  body { 
                      max-width: 980px; 
                      margin: 0 auto; 
                      padding: 45px; 
                      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Noto Sans, Helvetica, Arial, sans-serif;
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                      padding-bottom: 20px;
                      border-bottom: 2px solid #e1e4e8;
                  }
                  .session { 
                      margin: 30px 0; 
                      padding: 25px; 
                      border: 1px solid #e1e4e8; 
                      border-radius: 8px;
                      background: #f8f9fa;
                      transition: transform 0.2s, box-shadow 0.2s;
                  }
                  .session:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                  }
                  .updated { 
                      border-left: 4px solid #28a745; 
                      background: linear-gradient(to right, #f1f8ff, #f8f9fa);
                  }
                  .session h2 {
                      margin-top: 0;
                      color: #24292e;
                      display: flex;
                      align-items: center;
                      gap: 10px;
                  }
                  .links { 
                      display: flex; 
                      gap: 15px; 
                      margin-top: 15px; 
                      flex-wrap: wrap; 
                  }
                  .links a { 
                      padding: 10px 20px; 
                      background: #0366d6; 
                      color: white; 
                      text-decoration: none; 
                      border-radius: 6px; 
                      font-size: 14px;
                      font-weight: 500;
                      transition: background-color 0.2s;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                  }
                  .links a:hover { 
                      background: #0256cc; 
                  }
                  .links a.handson {
                      background: #28a745;
                  }
                  .links a.handson:hover {
                      background: #1e7e34;
                  }
                  .status { 
                      font-size: 12px; 
                      color: #6a737d; 
                      margin-top: 10px;
                      padding: 5px 10px;
                      background: #e1f5fe;
                      border-radius: 4px;
                      display: inline-block;
                  }
                  .update-time {
                      text-align: center;
                      color: #6a737d;
                      font-size: 14px;
                      margin-bottom: 30px;
                  }
              </style>
          </head>
          <body class="markdown-body">
              <div class="header">
                  <h1>ğŸ“š ã‚»ãƒŸãƒŠãƒ¼è³‡æ–™</h1>
                  <div class="update-time">æœ€çµ‚æ›´æ–°: 
          HTMLEOF
          date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M (JST)' >> docs/index.html
          cat >> docs/index.html << 'HTMLEOF'
          </div>
              </div>
          HTMLEOF
          
          # å…¨ã¦ã®æ—¥ä»˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ä¸€è¦§ä½œæˆï¼ˆæ–°ã—ã„é †ï¼‰
          find . -maxdepth 1 -type d -name '[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]' | sort -r | while read dir; do
            DATE_DIR=$(basename "$dir")
            
            # ä»Šå›æ›´æ–°ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
            IS_UPDATED=""
            if echo "${{ steps.find-dirs.outputs.all_dates }}" | grep -q "$DATE_DIR"; then
              IS_UPDATED="updated"
            fi
            
            echo "    <div class=\"session $IS_UPDATED\">" >> docs/index.html
            echo "        <h2>ğŸ“… $DATE_DIR $([ -n "$IS_UPDATED" ] && echo 'ğŸ†•')</h2>" >> docs/index.html
            echo "        <div class=\"links\">" >> docs/index.html
            
            # ã‚¹ãƒ©ã‚¤ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            if [ -f "docs/slides/$DATE_DIR.html" ]; then
              echo "            <a href=\"slides/$DATE_DIR.html\">ğŸ“Š ã‚¹ãƒ©ã‚¤ãƒ‰ (HTML)</a>" >> docs/index.html
            fi
            if [ -f "docs/slides/$DATE_DIR.pdf" ]; then
              echo "            <a href=\"slides/$DATE_DIR.pdf\">ğŸ“„ ã‚¹ãƒ©ã‚¤ãƒ‰ (PDF)</a>" >> docs/index.html
            fi
            
            # ãƒãƒ³ã‚ºã‚ªãƒ³ãƒªãƒ³ã‚¯ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            if [ -d "docs/handson/$DATE_DIR" ]; then
              echo "            <a href=\"handson/$DATE_DIR/\" class=\"handson\">ğŸ’» ãƒãƒ³ã‚ºã‚ªãƒ³</a>" >> docs/index.html
            fi
            
            echo "        </div>" >> docs/index.html
            
            # æ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            if [ -n "$IS_UPDATED" ]; then
              echo "        <div class=\"status\">âœ¨ ä»Šå›æ›´æ–°ã•ã‚Œã¾ã—ãŸ</div>" >> docs/index.html
            fi
            
            echo "    </div>" >> docs/index.html
          done
          
          cat >> docs/index.html << 'HTMLEOF'
              
              <div style="text-align: center; margin-top: 50px; padding-top: 30px; border-top: 1px solid #e1e4e8; color: #6a737d;">
                  <p>ğŸ¤– ã“ã®ãƒšãƒ¼ã‚¸ã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™</p>
              </div>
          </body>
          </html>
          HTMLEOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        if: steps.find-dirs.outputs.has_directories == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        if: steps.find-dirs.outputs.has_directories == 'true'
        run: |
          echo "## ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä»¥ä¸‹ã®è³‡æ–™ãŒå‡¦ç†ã•ã‚Œã¾ã—ãŸ:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "${{ steps.find-dirs.outputs.all_dates }}" | while read DATE_DIR; do
            if [ -n "$DATE_DIR" ]; then
              echo "### ğŸ“… $DATE_DIR" >> $GITHUB_STEP_SUMMARY
              
              if [ -f "docs/slides/$DATE_DIR.html" ]; then
                echo "- âœ… ã‚¹ãƒ©ã‚¤ãƒ‰ (HTML) ç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
              fi
              if [ -f "docs/slides/$DATE_DIR.pdf" ]; then
                echo "- âœ… ã‚¹ãƒ©ã‚¤ãƒ‰ (PDF) ç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
              fi
              if [ -d "docs/handson/$DATE_DIR" ]; then
                echo "- âœ… ãƒãƒ³ã‚ºã‚ªãƒ³è³‡æ–™ ã‚³ãƒ”ãƒ¼å®Œäº†" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "ğŸ”— **GitHub Pages URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

      - name: Display no directories message
        if: steps.find-dirs.outputs.has_directories == 'false'
        run: |
          echo "## â„¹ï¸ å‡¦ç†å¯¾è±¡ãªã—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ—¥ä»˜å½¢å¼ï¼ˆYYYY-MM-DDï¼‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY