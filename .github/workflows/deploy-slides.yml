name: Deploy Seminar Materials
on:
  push:
    branches: [ main ]
    paths:
      - '*/slide.md'
      - '*/handson/**'
      - '*/assets/**'
      - '.github/workflows/deploy-seminar-materials.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: 'Asia/Tokyo'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          npm install -g @marp-team/marp-cli

      - name: Build all materials
        run: |
          # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p output/slides
          mkdir -p output/handson
          
          # å…¨ã¦ã®æ—¥ä»˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‡¦ç†
          for DATE_DIR in $(find . -maxdepth 1 -type d -name '[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]' | sed 's|./||' | sort); do
            echo "Processing $DATE_DIR..."
            
            # ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ
            if [ -f "$DATE_DIR/slide.md" ]; then
              echo "- Generating slides..."
              
              # ã‚¢ã‚»ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
              mkdir -p "output/slides/$DATE_DIR"
              
              # ã‚¢ã‚»ãƒƒãƒˆã¨ç”»åƒã‚’ã‚³ãƒ”ãƒ¼
              if [ -d "$DATE_DIR/assets" ]; then
                cp -r "$DATE_DIR/assets" "output/slides/$DATE_DIR/"
              fi
              
              # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
              find "$DATE_DIR" -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" \) -exec cp {} "output/slides/$DATE_DIR/" \;
              
              # PDFã¯Marpã§ç”Ÿæˆ
              echo "  Generating PDF..."
              cd "$DATE_DIR" && marp slide.md -o slide.pdf --pdf --allow-local-files && cd ..
              mv "$DATE_DIR/slide.pdf" "output/slides/$DATE_DIR.pdf"
              
              # Markdownãƒ“ãƒ¥ãƒ¼ç”¨ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
              echo "  Creating Markdown view..."
              cat > "output/slides/$DATE_DIR.html" << VIEW_EOF
---
---
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>$DATE_DIR - ã‚»ãƒŸãƒŠãƒ¼è³‡æ–™</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <style>
        body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
            background-color: #ffffff;
        }
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
        }
        .markdown-body pre {
            background-color: #f6f8fa;
        }
        hr {
            height: 2px;
            border: none;
            background-color: #d0d7de;
            margin: 3em 0;
        }
        @media (max-width: 767px) {
            body { padding: 15px; }
        }
    </style>
</head>
<body>
    <article class="markdown-body">
VIEW_EOF
              
              # Markdownã®å†…å®¹ã‚’å‡¦ç†ã—ã¦HTMLã«åŸ‹ã‚è¾¼ã‚€
              cat "$DATE_DIR/slide.md" | sed 's/---/\n<hr>\n/g' >> "output/slides/$DATE_DIR.html"
              
              cat >> "output/slides/$DATE_DIR.html" << VIEW_EOF2
    </article>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
</body>
</html>
VIEW_EOF2
              
              # ç”»åƒãƒ‘ã‚¹ã‚’èª¿æ•´ï¼ˆHTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ï¼‰
              sed -i "s|!\[\([^]]*\)\](assets/\([^)]*\))|![\1]($DATE_DIR/assets/\2)|g" "output/slides/$DATE_DIR.html"
              sed -i "s|!\[\([^]]*\)\](./assets/\([^)]*\))|![\1]($DATE_DIR/assets/\2)|g" "output/slides/$DATE_DIR.html"
              sed -i "s|!\[\([^]]*\)\](\([^/:)][^)]*\))|![\1]($DATE_DIR/\2)|g" "output/slides/$DATE_DIR.html"
              
              # HTMLã‚¿ã‚°ã®ç”»åƒãƒ‘ã‚¹ã‚‚èª¿æ•´
              sed -i "s|<img\([^>]*\)src=\"assets/|<img\1src=\"$DATE_DIR/assets/|g" "output/slides/$DATE_DIR.html"
              sed -i "s|<img\([^>]*\)src=\"./assets/|<img\1src=\"$DATE_DIR/assets/|g" "output/slides/$DATE_DIR.html"
              
              # é‡è¤‡ã‚’é˜²ã
              sed -i "s|$DATE_DIR/$DATE_DIR|$DATE_DIR|g" "output/slides/$DATE_DIR.html"
            fi
            
            # ãƒãƒ³ã‚ºã‚ªãƒ³è³‡æ–™ã‚’ã‚³ãƒ”ãƒ¼
            if [ -d "$DATE_DIR/handson" ]; then
              echo "- Copying handson materials..."
              cp -r "$DATE_DIR/handson" "output/handson/$DATE_DIR"
            fi
          done

      - name: Create Jekyll config
        run: |
          cat > output/_config.yml << 'YAML_EOF'
          # Jekyllè¨­å®š
          markdown: kramdown
          highlighter: rouge
          
          # slidesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‡¦ç†
          include:
            - slides
          YAML_EOF

      - name: Generate index page
        run: |
          cat > output/index.html << 'HTML_EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ğŸ“š ã‚»ãƒŸãƒŠãƒ¼è³‡æ–™</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #f5f5f5;
                  }
                  .container {
                      background: white;
                      border-radius: 10px;
                      padding: 30px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1 {
                      text-align: center;
                      color: #333;
                  }
                  .seminar {
                      border: 1px solid #ddd;
                      border-radius: 8px;
                      padding: 20px;
                      margin: 15px 0;
                      background: #fafafa;
                  }
                  .seminar h2 {
                      margin-top: 0;
                      color: #0366d6;
                  }
                  .links {
                      display: flex;
                      gap: 10px;
                      flex-wrap: wrap;
                  }
                  .links a {
                      display: inline-block;
                      padding: 8px 16px;
                      background: #0366d6;
                      color: white;
                      text-decoration: none;
                      border-radius: 5px;
                      transition: background 0.3s;
                  }
                  .links a:hover {
                      background: #0256cc;
                  }
                  .links a.pdf {
                      background: #d73a49;
                  }
                  .links a.pdf:hover {
                      background: #cb2431;
                  }
                  .links a.handson {
                      background: #28a745;
                  }
                  .links a.handson:hover {
                      background: #218838;
                  }
                  .updated {
                      text-align: center;
                      color: #666;
                      margin-top: 30px;
                      font-size: 14px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ“š ã‚»ãƒŸãƒŠãƒ¼è³‡æ–™</h1>
          HTML_EOF
          
          # å„ã‚»ãƒŸãƒŠãƒ¼ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
          for DATE_DIR in $(find . -maxdepth 1 -type d -name '[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]' | sed 's|./||' | sort -r); do
            if [ -f "output/slides/$DATE_DIR.md" ] || [ -f "output/slides/$DATE_DIR.pdf" ] || [ -d "output/handson/$DATE_DIR" ]; then
              echo "<div class=\"seminar\">" >> output/index.html
              echo "  <h2>ğŸ“… $DATE_DIR</h2>" >> output/index.html
              echo "  <div class=\"links\">" >> output/index.html
              
              [ -f "output/slides/$DATE_DIR.html" ] && echo "    <a href=\"slides/$DATE_DIR.html\">ğŸ“ ã‚¹ãƒ©ã‚¤ãƒ‰ (Markdown)</a>" >> output/index.html
              [ -f "output/slides/$DATE_DIR.pdf" ] && echo "    <a href=\"slides/$DATE_DIR.pdf\" class=\"pdf\">ğŸ“„ ã‚¹ãƒ©ã‚¤ãƒ‰ (PDF)</a>" >> output/index.html
              [ -d "output/handson/$DATE_DIR" ] && echo "    <a href=\"handson/$DATE_DIR/\" class=\"handson\">ğŸ’» ãƒãƒ³ã‚ºã‚ªãƒ³</a>" >> output/index.html
              
              echo "  </div>" >> output/index.html
              echo "</div>" >> output/index.html
            fi
          done
          
          echo "<div class=\"updated\">æœ€çµ‚æ›´æ–°: $(TZ='Asia/Tokyo' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M') (JST)</div>" >> output/index.html
          echo "</div></body></html>" >> output/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          force_orphan: true
          enable_jekyll: true