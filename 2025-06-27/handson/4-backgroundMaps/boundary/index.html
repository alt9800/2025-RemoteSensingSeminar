<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapLibre ã‚¿ã‚¤ãƒ«å¢ƒç•Œè¡¨ç¤ºãƒãƒƒãƒ—</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 250px;
        }
        
        .control-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .info-item {
            margin: 8px 0;
            font-size: 14px;
            color: #555;
        }
        
        .info-label {
            font-weight: bold;
            color: #333;
        }
        
        .toggle-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: 100%;
        }
        
        .toggle-button:hover {
            background: #005a87;
        }
        
        .toggle-button.active {
            background: #ff6b6b;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .modal-title {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        
        .close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-info {
            margin: 10px 0;
            font-size: 15px;
        }
        
        .modal-info strong {
            color: #333;
            display: inline-block;
            width: 120px;
        }
        
        .info-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .info-button:hover {
            background: #218838;
        }
        
        .style-selector {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .style-selector h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        
        .style-selector select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <h3>ğŸ—ºï¸ ãƒãƒƒãƒ—æƒ…å ±</h3>
        <div class="info-item">
            <span class="info-label">ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«:</span>
            <span id="zoom-level">10</span>
        </div>
        <div class="info-item">
            <span class="info-label">ç·¯åº¦:</span>
            <span id="latitude">35.6762</span>
        </div>
        <div class="info-item">
            <span class="info-label">çµŒåº¦:</span>
            <span id="longitude">139.6503</span>
        </div>
        <button id="toggle-tiles" class="toggle-button">ã‚¿ã‚¤ãƒ«å¢ƒç•Œã‚’è¡¨ç¤º</button>
        
        <div class="style-selector">
            <h4>ğŸ¨ ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«</h4>
            <select id="style-selector">
                <option value="osm">OpenStreetMap</option>
                <option value="osm-humanitarian">äººé“æ”¯æ´ã‚¹ã‚¿ã‚¤ãƒ«</option>
                <option value="cartodb-positron">CartoDB Positron</option>
                <option value="cartodb-dark">CartoDB Dark</option>
                <option value="stamen-toner">Stamen Toner</option>
                <option value="stamen-terrain">Stamen Terrain</option>
                <option value="wikimedia">Wikimedia</option>
                <option value="esri-world-imagery">è¡›æ˜Ÿç”»åƒ (Esri)</option>
            </select>
        </div>
    </div>
    
    <button id="info-button" class="info-button">â„¹ï¸</button>
    
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ãƒãƒƒãƒ—è©³ç´°æƒ…å ±</h2>
                <button class="close">&times;</button>
            </div>
            <div class="modal-info">
                <strong>ç¾åœ¨ã®ã‚ºãƒ¼ãƒ :</strong> <span id="modal-zoom">10</span>
            </div>
            <div class="modal-info">
                <strong>ä¸­å¿ƒç·¯åº¦:</strong> <span id="modal-lat">35.6762</span>Â°
            </div>
            <div class="modal-info">
                <strong>ä¸­å¿ƒçµŒåº¦:</strong> <span id="modal-lng">139.6503</span>Â°
            </div>
            <div class="modal-info">
                <strong>ã‚¿ã‚¤ãƒ«ã‚½ãƒ¼ã‚¹:</strong> <span id="modal-source">OpenStreetMap</span>
            </div>
            <div class="modal-info">
                <strong>åº§æ¨™ç³»:</strong> Web Mercator (EPSG:3857)
            </div>
            <div class="modal-info">
                <strong>ã‚¿ã‚¤ãƒ«å¢ƒç•Œ:</strong> <span id="modal-tiles-status">éè¡¨ç¤º</span>
            </div>
        </div>
    </div>

    <script>
        // ã‚¿ã‚¤ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ã®å®šç¾©
        const tileServices = {
            'osm': {
                name: 'OpenStreetMap',
                url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: 'Â© OpenStreetMap contributors'
            },
            'stamen-toner': {
                name: 'Stamen Toner',
                url: 'https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}.png',
                attribution: 'Â© Stamen Design, Â© OpenStreetMap contributors'
            },
            'stamen-terrain': {
                name: 'Stamen Terrain',
                url: 'https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}.png',
                attribution: 'Â© Stamen Design, Â© OpenStreetMap contributors'
            },
            'esri-world-imagery': {
                name: 'Esri World Imagery',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Â© Esri, Â© OpenStreetMap contributors'
            }
        };

        // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'current-tiles': {
                        type: 'raster',
                        tiles: [tileServices.osm.url],
                        tileSize: 256,
                        attribution: tileServices.osm.attribution
                    }
                },
                layers: [
                    {
                        id: 'current-tiles',
                        type: 'raster',
                        source: 'current-tiles'
                    }
                ]
            },
            center: [139.6503, 35.6762], // æ±äº¬
            zoom: 10
        });

        // UIè¦ç´ ã®å–å¾—
        const zoomElement = document.getElementById('zoom-level');
        const latElement = document.getElementById('latitude');
        const lngElement = document.getElementById('longitude');
        const toggleButton = document.getElementById('toggle-tiles');
        const infoButton = document.getElementById('info-button');
        const modal = document.getElementById('info-modal');
        const closeButton = document.querySelector('.close');
        const styleSelector = document.getElementById('style-selector');
        
        let tilesVisible = false;
        let currentStyle = 'osm';

        // æƒ…å ±æ›´æ–°é–¢æ•°
        function updateInfo() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            
            zoomElement.textContent = zoom.toFixed(2);
            latElement.textContent = center.lat.toFixed(6);
            lngElement.textContent = center.lng.toFixed(6);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æƒ…å ±ã‚‚æ›´æ–°
            document.getElementById('modal-zoom').textContent = zoom.toFixed(2);
            document.getElementById('modal-lat').textContent = center.lat.toFixed(6);
            document.getElementById('modal-lng').textContent = center.lng.toFixed(6);
        }

        // ã‚¿ã‚¤ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã®å¤‰æ›´
        function changeStyle(styleId) {
            const service = tileServices[styleId];
            if (!service) return;
            
            // ã‚¿ã‚¤ãƒ«å¢ƒç•ŒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸€æ™‚çš„ã«éè¡¨ç¤º
            const wasTilesVisible = tilesVisible;
            if (tilesVisible) {
                toggleTileBoundaries();
            }
            
            // ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            map.getSource('current-tiles').setTiles([service.url]);
            
            // ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
            currentStyle = styleId;
            
            // ã‚¿ã‚¤ãƒ«å¢ƒç•Œã‚’å†è¡¨ç¤º
            if (wasTilesVisible) {
                setTimeout(() => toggleTileBoundaries(), 100);
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«æƒ…å ±ã‚’æ›´æ–°
            document.getElementById('modal-tiles-status').textContent = tilesVisible ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º';
        }

        // ã‚¿ã‚¤ãƒ«å¢ƒç•Œã®è¡¨ç¤º/éè¡¨ç¤º
        function toggleTileBoundaries() {
            if (tilesVisible) {
                // ã‚¿ã‚¤ãƒ«å¢ƒç•Œã‚’éè¡¨ç¤º
                if (map.getLayer('tile-boundaries')) {
                    map.removeLayer('tile-boundaries');
                }
                if (map.getSource('tile-grid')) {
                    map.removeSource('tile-grid');
                }
                toggleButton.textContent = 'ã‚¿ã‚¤ãƒ«å¢ƒç•Œã‚’è¡¨ç¤º';
                toggleButton.classList.remove('active');
                document.getElementById('modal-tiles-status').textContent = 'éè¡¨ç¤º';
                tilesVisible = false;
            } else {
                // ã‚¿ã‚¤ãƒ«å¢ƒç•Œã‚’è¡¨ç¤º
                addTileBoundaries();
                toggleButton.textContent = 'ã‚¿ã‚¤ãƒ«å¢ƒç•Œã‚’éè¡¨ç¤º';
                toggleButton.classList.add('active');
                document.getElementById('modal-tiles-status').textContent = 'è¡¨ç¤ºä¸­';
                tilesVisible = true;
            }
        }

        // ã‚¿ã‚¤ãƒ«å¢ƒç•Œã®è¿½åŠ 
        function addTileBoundaries() {
            const zoom = Math.floor(map.getZoom());
            const bounds = map.getBounds();
            
            // ã‚¿ã‚¤ãƒ«å¢ƒç•Œã®GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            const tileGrid = generateTileGrid(bounds, zoom);
            
            map.addSource('tile-grid', {
                type: 'geojson',
                data: tileGrid
            });

            map.addLayer({
                id: 'tile-boundaries',
                type: 'line',
                source: 'tile-grid',
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 2,
                    'line-opacity': 0.8
                }
            });
        }

        // ã‚¿ã‚¤ãƒ«ã‚°ãƒªãƒƒãƒ‰ã®ç”Ÿæˆ
        function generateTileGrid(bounds, zoom) {
            const features = [];
            
            // ã‚¿ã‚¤ãƒ«åº§æ¨™ã®è¨ˆç®—
            const nwTile = deg2tile(bounds.getNorth(), bounds.getWest(), zoom);
            const seTile = deg2tile(bounds.getSouth(), bounds.getEast(), zoom);
            
            // æ¨ªç·šã®ç”Ÿæˆ
            for (let y = Math.max(0, nwTile.y - 1); y <= seTile.y + 1; y++) {
                const lat = tile2deg(0, y, zoom).lat;
                features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: [
                            [bounds.getWest() - 1, lat],
                            [bounds.getEast() + 1, lat]
                        ]
                    }
                });
            }
            
            // ç¸¦ç·šã®ç”Ÿæˆ
            for (let x = Math.max(0, nwTile.x - 1); x <= seTile.x + 1; x++) {
                const lng = tile2deg(x, 0, zoom).lng;
                features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: [
                            [lng, bounds.getSouth() - 0.5],
                            [lng, bounds.getNorth() + 0.5]
                        ]
                    }
                });
            }
            
            return {
                type: 'FeatureCollection',
                features: features
            };
        }

        // åº¦æ•°ã‚’ã‚¿ã‚¤ãƒ«åº§æ¨™ã«å¤‰æ›
        function deg2tile(lat_deg, lon_deg, zoom) {
            const lat_rad = lat_deg * Math.PI / 180;
            const n = Math.pow(2, zoom);
            const x = Math.floor((lon_deg + 180) / 360 * n);
            const y = Math.floor((1 - Math.asinh(Math.tan(lat_rad)) / Math.PI) / 2 * n);
            return { x: x, y: y };
        }

        // ã‚¿ã‚¤ãƒ«åº§æ¨™ã‚’åº¦æ•°ã«å¤‰æ›
        function tile2deg(x, y, zoom) {
            const n = Math.pow(2, zoom);
            const lng = x / n * 360 - 180;
            const lat_rad = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n)));
            const lat = lat_rad * 180 / Math.PI;
            return { lat: lat, lng: lng };
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        map.on('load', updateInfo);
        map.on('move', updateInfo);
        map.on('zoom', () => {
            updateInfo();
            if (tilesVisible) {
                // ã‚ºãƒ¼ãƒ æ™‚ã«ã‚¿ã‚¤ãƒ«å¢ƒç•Œã‚’æ›´æ–°
                if (map.getLayer('tile-boundaries')) {
                    map.removeLayer('tile-boundaries');
                    map.removeSource('tile-grid');
                    addTileBoundaries();
                }
            }
        });

        toggleButton.addEventListener('click', toggleTileBoundaries);

        // ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        styleSelector.addEventListener('change', (e) => {
            changeStyle(e.target.value);
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚‚æ›´æ–°
            document.getElementById('modal-source').textContent = tileServices[e.target.value].name;
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        infoButton.addEventListener('click', () => {
            updateInfo(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«æƒ…å ±ã‚’æ›´æ–°
            modal.style.display = 'block';
        });

        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¿½åŠ 
        map.addControl(new maplibregl.NavigationControl());
        map.addControl(new maplibregl.ScaleControl());
    </script>
</body>
</html>